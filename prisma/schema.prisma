// Xeno FDE Assignment - Prisma Schema
// Multi-tenant Shopify Data Platform
// PostgreSQL on Railway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @db.Text // Argon2 hash
  name          String?
  
  // Email verification (optional for MVP)
  emailVerified Boolean   @default(false)
  
  // Relationships
  tenant        Tenant?   // 1:1 - User can have one tenant (store)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@map("users")
}

// ============================================================================
// MULTI-TENANCY CORE
// ============================================================================

model Tenant {
  id                String       @id @default(uuid())
  shopifyDomain     String       @unique
  shopName          String?
  email             String?
  accessToken       String       @db.Text // AES-256 encrypted
  accessTokenHash   String       // SHA-256 for quick lookup
  scope             String[]     // Granted OAuth scopes
  
  // User ownership (1:1)
  userId            String?      @unique
  user              User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Subscription & limits
  status            TenantStatus @default(ACTIVE)
  planTier          PlanTier     @default(FREE)
  monthlyApiCalls   Int          @default(0)
  apiCallLimit      Int          @default(10000)
  
  // Relationships
  customers         Customer[]
  orders            Order[]
  products          Product[]
  segments          Segment[]
  events            Event[]
  webhookEvents     WebhookEvent[]
  syncJobs          SyncJob[]
  
  // Metadata
  onboardedAt       DateTime     @default(now())
  lastSyncAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@index([shopifyDomain])
  @@index([status, planTier])
  @@index([userId])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CHURNED
}

enum PlanTier {
  FREE
  STARTER
  GROWTH
  ENTERPRISE
}

// ============================================================================
// CUSTOMER DOMAIN (RFM-Optimized)
// ============================================================================

model Customer {
  id                 String        @id @default(uuid())
  tenantId           String
  shopifyId          String        // Shopify customer ID
  
  // Identity
  email              String?
  phone              String?
  firstName          String?
  lastName           String?
  
  // Computed Metrics (Denormalized for Performance)
  totalSpent         Decimal       @default(0) @db.Decimal(12, 2)
  ordersCount        Int           @default(0)
  avgOrderValue      Decimal       @default(0) @db.Decimal(12, 2)
  lastOrderDate      DateTime?
  firstOrderDate     DateTime?
  daysSinceLastOrder Int?          // Computed daily
  
  // RFM Scores (1-5 scale, computed daily)
  recencyScore       Int?          @db.SmallInt
  frequencyScore     Int?          @db.SmallInt
  monetaryScore      Int?          @db.SmallInt
  rfmSegment         RFMSegment?
  rfmComputedAt      DateTime?
  
  // Behavioral flags
  isHighValue        Boolean       @default(false) // totalSpent > P90
  isChurnRisk        Boolean       @default(false) // No order in 90 days
  hasAbandonedCart   Boolean       @default(false)
  
  // Relationships
  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders             Order[]
  events             Event[]
  segmentMembers     SegmentMember[]
  
  // Timestamps
  shopifyCreatedAt   DateTime
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  @@unique([tenantId, shopifyId])
  @@index([tenantId, email])
  @@index([tenantId, totalSpent(sort: Desc)])
  @@index([tenantId, lastOrderDate(sort: Desc)])
  @@index([tenantId, firstOrderDate(sort: Desc)]) // For cohort analysis
  @@index([tenantId, rfmSegment])
  @@index([tenantId, isHighValue])
  @@index([tenantId, isChurnRisk]) // For churn risk queries
  @@map("customers")
}

enum RFMSegment {
  CHAMPIONS          // 5,5,5 - Best customers
  LOYAL              // 4-5, 4-5, 3-5
  POTENTIAL_LOYALIST // 3-5, 1-3, 1-3
  NEW_CUSTOMERS      // 5, 1, 1
  PROMISING          // 4-5, 1, 1
  NEED_ATTENTION     // 3-4, 3-4, 3-4
  ABOUT_TO_SLEEP     // 2-3, 2-3, 2-3
  AT_RISK            // 2-3, 3-5, 3-5
  CANNOT_LOSE        // 1-2, 4-5, 4-5
  HIBERNATING        // 1-2, 1-2, 1-2
  LOST               // 1, 1, 1-2
}

// ============================================================================
// ORDER DOMAIN
// ============================================================================

model Order {
  id                String            @id @default(uuid())
  tenantId          String
  shopifyId         String
  customerId        String?
  
  // Order details
  orderNumber       Int
  orderName         String            // e.g., "#1001"
  totalPrice        Decimal           @db.Decimal(12, 2)
  subtotalPrice     Decimal           @db.Decimal(12, 2)
  totalTax          Decimal           @db.Decimal(12, 2)
  totalDiscounts    Decimal           @db.Decimal(12, 2)
  
  // Status
  financialStatus   FinancialStatus
  fulfillmentStatus FulfillmentStatus?
  cancelledAt       DateTime?
  
  // Line items (JSON for flexibility)
  lineItems         Json              // Array of {product_id, title, quantity, price}
  lineItemsCount    Int               @default(0)
  
  // Dimensions (for analytics)
  currency          String            @default("USD") @db.VarChar(3)
  orderDate         DateTime
  orderMonth        String            // YYYY-MM for partitioning
  
  // Relationships
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer          Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Timestamps
  shopifyCreatedAt  DateTime
  shopifyUpdatedAt  DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@unique([tenantId, shopifyId])
  @@index([tenantId, orderDate(sort: Desc)])
  @@index([tenantId, customerId])
  @@index([tenantId, orderMonth])
  @@index([tenantId, financialStatus])
  @@map("orders")
}

enum FinancialStatus {
  PENDING
  AUTHORIZED
  PARTIALLY_PAID
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  VOIDED
}

enum FulfillmentStatus {
  FULFILLED
  PARTIAL
  RESTOCKED
  PENDING
}

// ============================================================================
// PRODUCT CATALOG
// ============================================================================

model Product {
  id                String        @id @default(uuid())
  tenantId          String
  shopifyId         String
  
  // Product info
  title             String
  description       String?       @db.Text
  vendor            String?
  productType       String?
  status            ProductStatus @default(ACTIVE)
  
  // Pricing (from first variant for simplicity)
  price             Decimal?      @db.Decimal(12, 2)
  compareAtPrice    Decimal?      @db.Decimal(12, 2)
  
  // Variants (JSON array)
  variants          Json
  variantCount      Int           @default(1)
  
  // Media
  images            Json          // Array of {src, alt}
  featuredImage     String?       @db.Text
  
  // Relationships
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Timestamps
  shopifyCreatedAt  DateTime
  shopifyUpdatedAt  DateTime
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@unique([tenantId, shopifyId])
  @@index([tenantId, status])
  @@index([tenantId, productType])
  @@map("products")
}

enum ProductStatus {
  ACTIVE
  ARCHIVED
  DRAFT
}

// ============================================================================
// EVENTS (Cart Abandonment, Checkouts)
// ============================================================================

model Event {
  id          String      @id @default(uuid())
  tenantId    String
  customerId  String?
  
  // Event classification
  eventType   EventType
  eventSource EventSource @default(WEBHOOK)
  
  // Event payload
  payload     Json
  value       Decimal?    @db.Decimal(12, 2) // Cart value, order value, etc.
  
  // Context
  sessionId   String?
  userAgent   String?     @db.Text
  ipAddress   String?
  
  // Relationships
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer    Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Timestamps
  occurredAt  DateTime
  createdAt   DateTime    @default(now())
  
  @@index([tenantId, eventType, occurredAt(sort: Desc)])
  @@index([tenantId, customerId])
  @@map("events")
}

enum EventType {
  CART_ABANDONED
  CHECKOUT_STARTED
  CHECKOUT_COMPLETED
  CHECKOUT_ABANDONED
  PRODUCT_VIEWED
  PRODUCT_ADDED_TO_CART
}

enum EventSource {
  WEBHOOK
  API
  BATCH_IMPORT
}

// ============================================================================
// SEGMENTATION ENGINE
// ============================================================================

model Segment {
  id               String          @id @default(uuid())
  tenantId         String
  
  // Segment definition
  name             String
  description      String?         @db.Text
  filters          Json            // Flexible filter DSL
  
  // Computed state
  customerCount    Int             @default(0)
  estimatedRevenue Decimal         @default(0) @db.Decimal(12, 2)
  lastComputedAt   DateTime?
  
  // Metadata
  isActive         Boolean         @default(true)
  createdBy        String?         // User ID if multi-user
  
  // Relationships
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members          SegmentMember[]
  
  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  @@index([tenantId, isActive])
  @@map("segments")
}

model SegmentMember {
  id                  String      @id @default(uuid())
  segmentId           String
  customerId          String
  
  // Snapshot of customer state when added
  totalSpentSnapshot  Decimal     @db.Decimal(12, 2)
  rfmSegmentSnapshot  RFMSegment?
  
  // Relationships
  segment             Segment     @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  customer            Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Timestamps
  addedAt             DateTime    @default(now())
  
  @@unique([segmentId, customerId])
  @@index([segmentId])
  @@index([customerId])
  @@map("segment_members")
}

// ============================================================================
// OPERATIONAL TABLES
// ============================================================================

model WebhookEvent {
  id              String            @id @default(uuid())
  tenantId        String
  
  // Shopify webhook metadata
  eventId         String            @unique // X-Shopify-Event-Id (idempotency)
  topic           String
  shopifyDomain   String
  
  // Processing
  payload         Json
  status          WebhookEventStatus @default(PENDING)
  processed       Boolean           @default(false)
  processedAt     DateTime?
  processingError String?           @db.Text
  retryCount      Int               @default(0)
  
  // Verification
  hmacValid       Boolean           @default(false)
  
  // Relationships
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Timestamps
  receivedAt      DateTime          @default(now())
  
  @@index([tenantId, topic, receivedAt(sort: Desc)])
  @@index([processed, receivedAt])
  @@index([status, receivedAt])
  @@map("webhook_events")
}

enum WebhookEventStatus {
  PENDING
  PROCESSED
  FAILED
}

model SyncJob {
  id               String       @id @default(uuid())
  tenantId         String
  
  // Job definition
  resourceType     ResourceType
  mode             SyncMode     @default(INCREMENTAL)
  status           JobStatus
  
  // Progress tracking
  recordsProcessed Int          @default(0)
  recordsFailed    Int          @default(0)
  totalRecords     Int?
  progressPercent  Int          @default(0)
  
  // Error handling
  error            String?      @db.Text
  errorStack       String?      @db.Text
  retryCount       Int          @default(0)
  
  // Timing
  startedAt        DateTime?
  completedAt      DateTime?
  durationMs       Int?
  
  // Relationships
  tenant           Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt        DateTime     @default(now())
  
  @@index([tenantId, status, createdAt(sort: Desc)])
  @@index([status, startedAt])
  @@map("sync_jobs")
}

enum ResourceType {
  CUSTOMERS
  ORDERS
  PRODUCTS
  CART_ABANDONMENTS
  CHECKOUTS
}

enum SyncMode {
  FULL        // Re-sync everything
  INCREMENTAL // Only changed since last sync
  BACKFILL    // Historical data
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// SHOPIFY SESSION (For OAuth flow)
// ============================================================================

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?   // Shopify user ID (not our User)
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop])
  @@map("shopify_sessions")
}
